<template>

  <style>

    :host {
      position: absolute;
      left: 0;
      top: 0;
    }

    .hidden {
      visibility: hidden;
      pointer-events: none;
    }

    ul {
      margin: 0;
      width: 200px;
      padding: 0;
      background: #434343;
      color: #ccc;
      list-style: none;
      box-shadow: 3px 3px 10px rgba(0, 0, 0, .4);
    }

    li {
      padding: 0;
    }

    li.item {
      position: relative;
      padding: 5px 5px 5px 30px;
    }

    li.item:hover {
      background-color: #c78214;
      color: #fff;
    }

    li.checked:before {
      content: "";
      position: absolute;
      left: 10px;
      top: 50%;
      display: block;
      margin: -5px 0 0 0;
      width: 8px;
      height: 8px;
      background-color: #ccc;
      border-radius: 50%;
    }

    li.checked:hover:before {
      background-color: #fff;
    }

    li.separator {
      margin: 5px 0;
      border-top: 1px solid #777;
    }

  </style>

  <ul class="hidden"></ul>

</template>

<script>
(() => {
  "use strict";

  var doc = document.currentScript.ownerDocument;

  var MenuItem = class {

    constructor(item) {
      this._el = document.createElement("li");
      this._type = item.type;
      if (this._type === "separator")
        this._el.classList.add("separator");
      else {
        this._el.classList.add("item");
        this.label = item.label;
        this.checked = item.checked || false;
        this.checkable = item.checkable || false;
        this.disabled = item.disabled || false;
        this.onclick = item.onclick;
        this.click = item.click;
      }
    }

    get type() { return this._type; }

    get el() { return this._el; }

    get label() { return this._label; }
    set label(v) {
      this._el.textContent = v;
      this._label = v;
    }

    get checked() { return this._checked; }
    set checked(v) {
      if (v) this._el.classList.add("checked");
      else this._el.classList.remove("checked");
      this._checked = v;
    }

    get disabled() { return this._disabled; }
    set disabled(v) {
      if (v) this._el.classList.add("disabled");
      else this._el.classList.remove("disabled");
      this._disabled = v;
    }

    on(type, listener, capture) {
      this._el.addEventListener(type, listener, capture);
    }

    off(type, listener, capture) {
      this._el.removeEventListener(type, listener, capture);
    }

  };

  var Menu = class extends HTMLElement {

    createdCallback() {
      var root = this.createShadowRoot();
      var template = doc.querySelector("template");
      root.appendChild(document.importNode(template.content, true));

      this._menu = root.querySelector("ul");
      this._menu.addEventListener("click", e => e.stopPropagation());

      this._items = [];
      this._hidden = true;

      this._menuCb = (e => {
        if (this.inside(e.clientX, e.clientY))
          return;
        if (this.parentNode) this.hide();
        e.stopPropagation();
      }).bind(this);

      this._stopPropagationCb = e => e.stopPropagation();
    }

    get items() {
      return this._items;
    }

    inside(x, y) {
      var rect = this._menu.getBoundingClientRect();
      return rect.left <= x && x <= rect.right &&
        rect.top <= y && y <= rect.bottom;
    }

    add(item, index) {
      if (index instanceof MenuItem) {
        index = this._items.indexOf(index);
      }

      var menuItem = item instanceof MenuItem ? item : new MenuItem(item);

      menuItem.on("click", (e => {
        if (!menuItem.disabled) {
          if (menuItem.checkable)
            menuItem.checked = !menuItem.checked;
          if (typeof menuItem.click === "function")
            menuItem.click(menuItem);
          this.hide();
        }
        e.stopPropagation();
      }).bind(this));

      if (index >= 0 && index < this._items.length) {
        this._items.splice(index, 0, menuItem);
        this._menu.insertBefore(menuItem.el, this._menu.childNodes[index]);
      } else {
        this._items.push(menuItem);
        this._menu.appendChild(menuItem.el);
      }
    }

    show(x, y) {
      var left = x, top = y;
      document.body.appendChild(this);
      const rect = this._menu.getBoundingClientRect();
      if (window.innerWidth < x + rect.width)
        left -= rect.width;
      if (window.innerHeight < y + rect.height)
        top -= rect.height;
      this.style.left = left + "px";
      this.style.top = top + "px";
      this._menu.classList.remove("hidden");
      window.addEventListener("click", this._menuCb, true);
      window.addEventListener("mousemove", this._stopPropagationCb, true);
      window.addEventListener("mouseout", this._stopPropagationCb, true);
    }

    hide() {
      this._menu.classList.add("hidden");
      this.style.left = 0;
      this.style.top = 0;
      window.removeEventListener("click", this._menuCb, true);
      window.removeEventListener("mousemove", this._stopPropagationCb, true);
      window.removeEventListener("mouseout", this._stopPropagationCb, true);
      if (this.parentNode) document.body.removeChild(this);
    }

  };

  window.jikkyo.Menu = document.registerElement("jikkyo-menu", {
    prototype: Menu.prototype
  });

  window.jikkyo.Menuitem = MenuItem;

})();
</script>

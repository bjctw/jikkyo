<template>
  <style>

    :host {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      height: 28px;
      overflow: hidden;
    }

    .container, .draggable, .title, .btns {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
    }

    .container {
      bottom: auto;
      height: 28px;
      background: #444;
      color: #aaa;
      border-bottom: 1px solid #555;
      line-height: 28px;
      transition: top .2s ease-in-out;
      box-sizing: border-box;
    }

    .draggable {
      top: 10px;
      -webkit-app-region: drag;
    }

    .container.hidden {
      top: -28px;
    }

    .title {
      font-size: 14px;
      text-align: center;
    }

    .btns {
      display: flex;
      padding-right: 6px;
      vertical-align: middle;
      box-sizing: border-box;
      justify-content: flex-end;
      align-items: center;
    }

    .btn {
      transition: background-color .1s ease-in-out;
      -webkit-app-region: no-drag;
    }

    /* Windows/Linux */

    .win .btns {
      flex-direction: row;
    }

    .win .btn, .linux .btn {
      width: 16px;
      height: 16px;
      padding: 2px 6px;
      border-radius: 2px;
    }

    .win .btn:hover, .linux .btn:hover {
      background-color: #222;
    }

    .win .btn:active, .linux .btn:active {
      background-color: #000;
    }

    .win .btn-close, .linux .btn-close {
      background: transparent url("images/close.svg") no-repeat center center;
      background-size: 13px 13px;
    }

    .win .btn-maximize, .linux .btn-maximize {
      background: transparent url("images/maximize.svg") no-repeat center center;
      background-size: 13px 13px;
    }

    .win .btn-unmaximize, .linux .btn-unmaximize {
      background: transparent url("images/unmaximize.svg") no-repeat center center;
      background-size: 13px 13px;
    }

    .win .btn-minimize, .linux .btn-minimize {
      background: transparent url("images/minimize.svg") no-repeat center center;
      background-size: 13px 13px;
    }

    /* Mac */

    .mac .btns {
      flex-direction: row-reverse;
    }

    .mac .btn {
      width: 14px;
      height: 14px;
      margin-left: 10px;
      border-radius: 50%;
    }

    .mac .btn-close { background: #f73a4e; }
    .mac .btn-maximize,
    .mac .btn-unmaximize { background: #fdb122; }
    .mac .btn-minimize { background: #75d668; }

    .mac .btn-close:hover { background: #ef5666; }
    .mac .btn-maximize:hover { background: #ffc455; }
    .mac .btn-minimize:hover { background: #85e579; }

    .mac .btn-close:active { background: #c32e3e; }
    .mac .btn-maximize:active { background: #c68a19; }
    .mac .btn-minimize:active { background: #64be58; }

  </style>

  <div id="container" class="container">
    <div class="draggable"></div>
    <div class="title">Jikkyo</div>
    <div class="btns">
      <div id="minimize" class="btn btn-minimize"></div>
      <div id="maximize" class="btn btn-maximize"></div>
      <div id="close" class="btn btn-close"></div>
    </div>
  </div>

</template>

<script>
  (() => {
    "use strict";

    var win = require("nw.gui").Window.get();
    var maximized = require("./util/maximized")(win);
    var os = require("./util/os");
    var doc = document.currentScript.ownerDocument;

    var titlebar = class extends HTMLElement {

      hideTitlebar() {
        this.shadowRoot.getElementById("container").classList.add("hidden");
      }

      showTitlebar() {
        this.shadowRoot.getElementById("container").classList.remove("hidden");
      }

      toggleTitlebar() {
        if (this.isTitlebarShown) this.hideTitlebar();
        else this.showTitlebar();
      }

      get isTitlebarShown() {
        return !this.shadowRoot.getElementById("container").classList.contains("hidden");
      }

      createdCallback() {
        var root = this.createShadowRoot();
        var template = doc.querySelector("template");

        root.appendChild(document.importNode(template.content, true));

        this.shadowRoot.getElementById("container").classList.add(os);

        root.getElementById("minimize").addEventListener("click", e => {
          if (os === "mac") {
            if (maximized.maximized()) win.unmaximize();
            else win.maximize();
            return;
          } else {
            win.minimize();
          }
          e.stopPropagation();
        });

        root.getElementById("maximize").addEventListener("click", (e => {
          if (os === "mac") return win.minimize();
          if (maximized.maximized()) win.unmaximize();
          else win.maximize();
          e.stopPropagation();
        }).bind(this));

        root.getElementById("close").addEventListener("click", e => {
          win.close();
          e.stopPropagation();
        });

        this._maximizedChangedCb = (v => {
          if (os === "mac") return;
          var btn = this.shadowRoot.getElementById("maximize");
          if (v) {
            btn.classList.add("btn-unmaximize");
            btn.classList.remove("btn-maximize");
          } else {
            btn.classList.add("btn-maximize");
            btn.classList.remove("btn-unmaximize");
          }
        }).bind(this);
        maximized.on(this._maximizedChangedCb);
        maximized.emit();
      }

    };

    window.JikkyoTitlebar = document.registerElement("jikkyo-titlebar", {
      prototype: titlebar.prototype
    });

  })();
</script>
